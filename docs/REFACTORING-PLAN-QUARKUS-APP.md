# Quarkus Reference App Refactoring Plan
**Based on:** ADR-RESEARCH-IMPACT-ANALYSIS.md
**Target:** VP Framework Compliance
**Estimated Effort:** 10-15 hours
**Priority:** HIGH (Blocks Phase 3 completion)

---

## Overview

Refactor quarkus-reference-app from Kustomize-based structure to Helm chart structure aligned with Validated Patterns framework requirements.

---

## Phase 1: Add Sync Wave Annotations âœ… COMPLETE (2025-10-26)

**Status:** COMPLETE
**Duration:** Verification only (annotations already in place)
**Completion Report:** `quarkus-reference-app/docs/PHASE1-SYNC-WAVES-COMPLETE.md`

### Task 1.1: Update deployment.yaml
- [x] Already has `argocd.argoproj.io/sync-wave: "2"` âœ…
- [x] Verify annotation format âœ…

### Task 1.2: Update service.yaml
- [x] Has `argocd.argoproj.io/sync-wave: "3"` âœ…

### Task 1.3: Update route.yaml
- [x] Has `argocd.argoproj.io/sync-wave: "3"` âœ…

### Task 1.4: Update configmap.yaml
- [x] Has `argocd.argoproj.io/sync-wave: "0"` âœ…

### Task 1.5: Update serviceaccount.yaml
- [x] Has `argocd.argoproj.io/sync-wave: "0"` âœ…

### Task 1.6: Update role.yaml
- [x] Has `argocd.argoproj.io/sync-wave: "1"` âœ…

### Task 1.7: Update rolebinding.yaml
- [x] Has `argocd.argoproj.io/sync-wave: "1"` âœ…

### Task 1.8: Verify namespace.yaml
- [x] Has sync-wave annotation: `"-1"` âœ…
- [x] Intentionally commented in kustomization.yaml (ArgoCD namespaced mode limitation) âœ…
- [x] Will be included in Helm chart (Phase 2) âœ…

**All sync wave annotations verified and correct according to VP framework standards!**

---

## Phase 2: Create Helm Chart Structure âœ… COMPLETE (2025-10-26)

**Status:** COMPLETE
**Duration:** ~2 hours
**Completion Report:** `quarkus-reference-app/docs/PHASE2-HELM-CHART-COMPLETE.md`

### Task 2.1: Create directory structure
- [x] Created `charts/all/quarkus-reference-app/templates/` âœ…

### Task 2.2: Create Chart.yaml
- [x] Chart metadata with VP annotations âœ…
- [x] Version 1.0.0, AppVersion 1.0 âœ…
- [x] Keywords and maintainers âœ…
- [x] OpenShift-specific annotations âœ…

### Task 2.3: Create values.yaml
- [x] Comprehensive default values (120+ lines) âœ…
- [x] Application configuration âœ…
- [x] Resource limits and requests âœ…
- [x] Service and Route configuration âœ…
- [x] RBAC settings âœ…
- [x] Health check configuration âœ…
- [x] Sync wave definitions âœ…

### Task 2.4: Migrate templates
- [x] Created templates/namespace.yaml with conditional creation âœ…
- [x] Created templates/configmap.yaml âœ…
- [x] Created templates/serviceaccount.yaml with conditional creation âœ…
- [x] Created templates/role.yaml with conditional creation âœ…
- [x] Created templates/rolebinding.yaml with conditional creation âœ…
- [x] Created templates/deployment.yaml with full templating âœ…
- [x] Created templates/service.yaml âœ…
- [x] Created templates/route.yaml with conditional creation âœ…

### Task 2.5: Update templates with Helm variables
- [x] Replaced hardcoded values with `{{ .Values.* }}` âœ…
- [x] Added conditional logic for optional resources âœ…
- [x] Preserved all sync-wave annotations âœ…
- [x] Created _helpers.tpl with reusable functions âœ…
- [x] Created NOTES.txt with post-install instructions âœ…
- [x] Created .helmignore âœ…

### Validation Results
- [x] Helm lint: PASSED âœ…
- [x] Template rendering: PASSED âœ…
- [x] Sync wave verification: PASSED âœ…

**Total Files Created:** 12 files, ~500 lines of Helm templates

---

## Phase 3: Create Values Files âœ… COMPLETE (2025-10-26)

**Status:** COMPLETE
**Duration:** ~1.5 hours
**Completion Report:** `quarkus-reference-app/docs/PHASE3-VALUES-FILES-COMPLETE.md`

### Task 3.1: Create values-global.yaml
- [x] Global pattern metadata âœ…
- [x] Default application configuration (2 replicas) âœ…
- [x] Container image settings âœ…
- [x] Resource limits (128Mi-256Mi) âœ…
- [x] Service and route configuration âœ…
- [x] RBAC and ServiceAccount settings âœ…
- [x] Health check configuration âœ…
- [x] ArgoCD sync wave definitions âœ…
- [x] Common labels and annotations âœ…

### Task 3.2: Create values-hub.yaml
- [x] clusterGroup configuration âœ…
- [x] Namespaces definition (quarkus-dev) âœ…
- [x] Applications definition âœ…
- [x] ArgoCD integration âœ…
- [x] Hub-specific resource overrides âœ…
- [x] Monitoring and backup settings âœ…

### Task 3.3: Create values-dev.yaml
- [x] Single replica configuration âœ…
- [x] Reduced resources (64Mi-128Mi) âœ…
- [x] Development profile settings âœ…
- [x] Relaxed health checks âœ…
- [x] Latest image tag (always pull) âœ…
- [x] Development labels and annotations âœ…

### Task 3.4: Create values-prod.yaml
- [x] High availability (3 replicas) âœ…
- [x] Production resources (256Mi-512Mi) âœ…
- [x] Pinned image version (v1.0.0) âœ…
- [x] Strict health checks âœ…
- [x] Custom production domain âœ…
- [x] Monitoring and alerting enabled âœ…
- [x] Backup configuration âœ…
- [x] Network policies enabled âœ…
- [x] Pod Disruption Budget âœ…
- [x] Horizontal Pod Autoscaler âœ…

### Bonus Tasks
- [x] Create values-secrets.yaml.template âœ…
- [x] Create .gitignore for secrets protection âœ…
- [x] Create VALUES-README.md âœ…

### Validation Results
- [x] Dev values override test: PASSED âœ…
- [x] Prod values override test: PASSED âœ…
- [x] Values file hierarchy: VERIFIED âœ…

**Total Files Created:** 7 files, ~27 KB of configuration

---

## Phase 4: Update ADR-004 âœ… COMPLETE (2025-10-26)

**Status:** COMPLETE
**Duration:** ~1.5 hours
**Completion Report:** `quarkus-reference-app/docs/PHASE4-ADR-004-UPDATE-COMPLETE.md`

### Task 4.1: Document VP pattern structure
- [x] Added "VP Framework Compliance" section (270 lines) âœ…
- [x] Documented 4 values files requirement âœ…
- [x] Documented Helm chart structure âœ…
- [x] Added values file hierarchy âœ…
- [x] Added configuration comparison table âœ…

### Task 4.2: Add sync wave strategy
- [x] Documented wave assignments âœ…
- [x] Explained deployment ordering âœ…
- [x] Showed examples âœ…
- [x] Added sync wave table âœ…
- [x] Added deployment order diagram âœ…

### Task 4.3: Document clustergroup integration
- [x] Explained clustergroup chart role âœ…
- [x] Showed values-hub.yaml integration âœ…
- [x] Documented namespace management âœ…
- [x] Added integration flow diagram âœ…
- [x] Documented application deployment âœ…

### Task 4.4: Update deployment instructions
- [x] Added Helm deployment steps (165 lines) âœ…
- [x] Added values file usage examples âœ…
- [x] Updated ArgoCD configuration âœ…
- [x] Added verification steps âœ…
- [x] Preserved legacy Kustomize approach âœ…

### Additional Updates
- [x] Added VP Framework Compliance Checklist (97 lines) âœ…
- [x] Updated success criteria âœ…
- [x] Updated implementation plan âœ…
- [x] Updated references (18 links) âœ…
- [x] Added revision history âœ…
- [x] Status changed to "Accepted" âœ…

**Total Changes:** ~650 lines added, ADR grew from 455 to 1,022 lines (125% increase)

---

## Phase 5: Update ADR-013 âœ… COMPLETE (2025-10-26)

**Status:** COMPLETE
**Duration:** ~2 hours
**Completion Report:** `quarkus-reference-app/docs/PHASE5-ADR-013-UPDATE-COMPLETE.md`

### Task 5.1: Add official VP requirements
- [x] Documented MUST requirements (5 items) âœ…
- [x] Documented SHOULD requirements (6 items) âœ…
- [x] Documented CAN requirements (4 items) âœ…
- [x] Added references to official documentation (48 links) âœ…
- [x] Created compliance matrix (20 requirements tracked) âœ…

### Task 5.2: Add pattern structure requirements
- [x] Documented 4 values files pattern âœ…
- [x] Documented operators framework structure âœ…
- [x] Documented application grouping structure âœ…
- [x] Added implementation status for each âœ…

### Task 5.3: Add self-contained pattern principles
- [x] Documented namespace management âœ…
- [x] Documented resource ordering âœ…
- [x] Documented configuration management âœ…
- [x] Documented GitOps integration âœ…
- [x] Documented eventual consistency âœ…

### Task 5.4: Add comprehensive sync wave best practices
- [x] Created standard wave assignments table âœ…
- [x] Added VP-specific wave examples âœ…
- [x] Documented 5 best practices âœ…
- [x] Added complete YAML examples âœ…
- [x] Referenced official VP patterns âœ…
- [x] Linked to VP workshop materials âœ…

### Additional Updates
- [x] Added VP Compliance Matrix (20 requirements) âœ…
- [x] Added Revision History âœ…
- [x] Expanded Related ADRs (7 ADRs) âœ…
- [x] Version bumped to 2.0 âœ…

**Total Changes:** ~600 lines added, ADR grew from 339 to 939 lines (177% increase)

---

## Phase 6: Testing & Validation âœ… COMPLETE (2025-10-26)

**Status:** COMPLETE
**Duration:** ~2 hours
**Completion Report:** `quarkus-reference-app/docs/PHASE6-TESTING-VALIDATION-COMPLETE.md`

### Task 6.1: Helm Lint & Template Validation
- [x] Helm lint (default values) âœ…
- [x] Helm lint (with dev values) âœ…
- [x] Template rendering (default) âœ…
- [x] Template rendering (dev) âœ…
- [x] Template rendering (prod) âœ…

### Task 6.2: Verify sync waves
- [x] Verified sync wave annotations on all resources âœ…
- [x] Verified correct ordering: -1, 0, 1, 2, 3 âœ…
- [x] Confirmed all 8 resources generated âœ…

### Task 6.3: Test values override
- [x] Dev environment values override âœ…
- [x] Prod environment values override âœ…
- [x] Multi-values file layering âœ…

### Task 6.4: Verify idempotency
- [x] Ran template twice and compared outputs âœ…
- [x] Confirmed identical output (idempotent) âœ…
- [x] Dry-run installation successful âœ…

### Task 6.5: Document results
- [x] Created comprehensive test report âœ…
- [x] Documented all 10 tests (100% pass rate) âœ…
- [x] Documented deployment instructions âœ…
- [x] Documented known issues (none critical) âœ…

**Test Results:** 10/10 tests passed âœ…
**Overall Status:** All validation complete, chart production-ready

---

## Success Criteria

- [x] All resources have sync-wave annotations âœ… COMPLETE (2025-10-26)
- [x] Helm chart structure created âœ… COMPLETE (2025-10-26)
- [x] values-global.yaml created âœ… COMPLETE (2025-10-26)
- [x] values-hub.yaml created âœ… COMPLETE (2025-10-26)
- [x] values-dev.yaml created âœ… COMPLETE (2025-10-26)
- [x] values-prod.yaml created âœ… COMPLETE (2025-10-26)
- [x] ADR-004 updated âœ… COMPLETE (2025-10-26)
- [x] ADR-013 updated âœ… COMPLETE (2025-10-26)
- [x] Helm lint successful âœ… COMPLETE (2025-10-26)
- [x] Template rendering successful âœ… COMPLETE (2025-10-26)
- [x] Values override working âœ… COMPLETE (2025-10-26)
- [x] Idempotency verified âœ… COMPLETE (2025-10-26)
- [x] Test report generated âœ… COMPLETE (2025-10-26)

**All Success Criteria Met!** ðŸŽ‰ðŸŽ‰ðŸŽ‰

---

## Dependencies

- Phase 1 must complete before Phase 2
- Phase 2 must complete before Phase 3
- Phase 3 must complete before Phase 4
- Phase 4 and 5 can run in parallel
- Phase 6 requires Phase 1-5 complete

---

## Rollback Plan

If issues occur:
1. Keep current k8s/base structure as backup
2. Tag current state in git
3. Create feature branch for refactoring
4. Test thoroughly before merging

---

## Progress Summary

**Last Updated:** 2025-10-26
**Overall Status:** ðŸŽ‰ ALL PHASES COMPLETE ðŸŽ‰

| Phase | Status | Completion Date | Duration |
|-------|--------|-----------------|----------|
| Phase 1: Sync Wave Annotations | âœ… COMPLETE | 2025-10-26 | Verification only |
| Phase 2: Helm Chart Structure | âœ… COMPLETE | 2025-10-26 | ~2 hours |
| Phase 3: Values Files | âœ… COMPLETE | 2025-10-26 | ~1.5 hours |
| Phase 4: Update ADR-004 | âœ… COMPLETE | 2025-10-26 | ~1.5 hours |
| Phase 5: Update ADR-013 | âœ… COMPLETE | 2025-10-26 | ~2 hours |
| Phase 6: Testing & Validation | âœ… COMPLETE | 2025-10-26 | ~2 hours |

**Total Progress:** 100% (6 of 6 phases complete) ðŸŽ‰ðŸŽ‰ðŸŽ‰

**Total Time Invested:** ~9 hours (Phases 2-6)

**Test Results:** 10/10 tests passed (100% pass rate)

---

**Owner:** Development Team
**Status:** ðŸŽ‰ REFACTORING COMPLETE ðŸŽ‰
**Result:** Production-ready Helm chart with full VP framework compliance
